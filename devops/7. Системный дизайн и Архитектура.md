# Раздел VII: Системный дизайн и Архитектура

## 1. Основы масштабируемости и надежности

* **Vertical (вверх):** Добавляем CPU/RAM на текущий сервер. Предел — физические возможности "железа" и цена.
* **Horizontal (вширь):** Добавляем больше серверов. Предел практически отсутствует, но приложение должно быть **Stateless**.
* **CAP-теорема:** В распределенной системе при разделении сети (Partition) ты можешь выбрать только одно:
1. **Consistency (Согласованность):** Все узлы видят одинаковые данные одновременно.
2. **Availability (Доступность):** Каждый запрос получает ответ (успех/ошибка), но данные могут быть неактуальны.


* *В реальности:* DevOps чаще выбирает **AP** (система работает, данные "доедут" позже — *Eventual Consistency*).

---

## 2. Паттерны коммуникации

* **REST/gRPC (Синхронно):** Хорошо для простых цепочек. Минус: если сервис Б тормозит, сервис А тоже ждет и тратит ресурсы.
* **Message Queues (Асинхронно):** Kafka или RabbitMQ.
* **Pub/Sub:** Издатель кидает сообщение в очередь, его получают все подписанные сервисы.
* **Зачем:** Сглаживание пиков нагрузки (Backpressure) и изоляция сбоев. Если потребитель упал, сообщение подождет его в очереди.


* **Service Mesh (Istio):** "Умная сеть" поверх K8s. Позволяет делать **mTLS** (шифрование между подами) и **Canary-трафик** без правки кода приложения.

---

## 3. Работа с данными

* **Репликация:**
* **Master-Slave:** Пишем в мастер, читаем из реплик. Идеально для High Read нагрузки.
* **Master-Master:** Сложно. Проблемы конфликтов при записи.


* **Шардирование:** Разрезание таблицы (например, по `user_id % 10`). Позволяет базе расти бесконечно, но усложняет JOIN-запросы.
* **Кэширование:**
* **Cache Aside:** Приложение сначала смотрит в кэш (Redis), если там пусто — идет в БД и пишет в кэш.
* **Write-through:** Приложение пишет в кэш, а кэш сам сохраняет в БД.

---

## 4. Дизайн надежных систем (SRE Patterns)

* **Circuit Breaker (Предохранитель):** Если сервис Б начал отдавать ошибки, сервис А временно перестает к нему обращаться ("размыкает цепь"), отдавая заглушку. Это спасает систему от каскадного падения.
* **Graceful Degradation:** Если отвалился поиск, сайт должен показывать хотя бы статичную витрину, а не пустую страницу ошибки.
* **RTO vs RPO:**
* **RTO (Time):** Как быстро мы должны подняться после аварии (например, за 15 минут).
* **RPO (Point):** Сколько данных мы можем потерять (например, за последние 5 минут).

---

## 5. The Twelve-Factor App (Ключевые пункты для DevOps)

1. **Codebase:** Один репозиторий — много деплоев.
2. **Config:** Настройки (БД, ключи) храним только в **Environment Variables**, а не в коде.
3. **Backing services:** Относимся к БД и очередям как к подключаемым ресурсам (через URL).
4. **Stateless:** Процессы приложения не должны хранить данные на диске внутри себя.
5. **Port binding:** Приложение само слушает порт, а не ждет, что его запустят внутри Apache/Tomcat.

---

## 6. Практический кейс: Перенос монолита

**Алгоритм ответа на интервью:**

1. **Observability:** Сначала вешаем мониторинг на монолит, чтобы понять узкие места.
2. **CI/CD:** Настраиваем автоматическую сборку и деплой.
3. **Database:** Выносим БД на отдельный управляемый сервис (RDS/Postgres).
4. **Strangler Fig Pattern:** Начинаем "откусывать" от монолита по одному микросервису (например, сначала сервис авторизации) и переносить в K8s, перенаправляя трафик через Ingress.

---

### Твой финальный чек-лист:

Теперь у тебя есть база по всем 7 разделам. На собеседовании помни:

* **Не ври:** Если не знаешь технологию, скажи: "Я не работал с X, но работал с Y, и понимаю принцип их работы".
* **Думай вслух:** Интервьюеру важен ход твоих мыслей, а не только правильная команда.
* **Безопасность прежде всего:** В любой ответ вставляй фразу "и, конечно, мы закроем это в Vault / ограничим Network Policy".

**Мы прошли весь путь!** Хочешь, чтобы я подготовил для тебя **список из 20 самых коварных вопросов**, которые "валят" кандидатов на Senior-позиции, или, может, разберем **конкретный стек** (например, только AWS + Terraform + K8s)?