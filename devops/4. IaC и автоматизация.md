Переходим к **Разделу IV: Infrastructure as Code (IaC) и управление конфигурациями**.

В современном DevOps мы не настраиваем серверы вручную. Мы описываем инфраструктуру как код, что позволяет нам версионировать её, тестировать и быстро восстанавливать. Здесь два главных игрока: **Terraform** и **Ansible**.

Вот список проверочных вопросов, по которым мы сейчас пройдемся:

### 1. Концепции IaC

* В чем разница между **Декларативным** (Terraform) и **Императивным** (Ansible/Bash) подходами?
* Что такое **Идемпотентность** и почему это критически важно для DevOps?
* В чем разница между **Provisioning** (подготовка ресурсов) и **Configuration Management** (настройка софта)?

### 2. Terraform (Provisioning)

* Что такое **Terraform State**? Почему нельзя терять этот файл и как организовать совместную работу (State Locking)?
* Опиши жизненный цикл: `init`, `plan`, `apply`, `destroy`.
* Что такое **Modules** и зачем они нужны?
* Как работать с чувствительными данными (паролями) в Terraform?
* Что такое **Terragrunt** и какую проблему он решает?

### 3. Ansible (Configuration Management)

* Как Ansible подключается к серверам? (Agentless подход через SSH).
* Из чего состоит Ansible: **Inventory**, **Playbook**, **Role**, **Task**.
* Что такое **Handlers** и чем они отличаются от обычных задач?
* Как работает **Ansible Vault**?
* Что такое **Dynamic Inventory** (например, для AWS или GCP)?

---

# Ответы на Раздел IV: IaC и автоматизация

## 1. Декларативность vs Императивность

* **Декларативный (Terraform):** Ты описываешь *конечный результат* («Я хочу 3 сервера и базу данных»). Terraform сам вычисляет разницу между тем, что есть, и тем, что ты хочешь, и вносит изменения.
* **Императивный (Ansible/Bash):** Ты описываешь *шаги* («Создай сервер, потом установи Nginx, потом скопируй конфиг»).
* **Идемпотентность:** Свойство системы, при котором повторное выполнение одной и той же операции дает тот же результат без побочных эффектов. (Например: команда "создать папку, если её нет" — идемпотентна. Команда "добавить строку в конец файла" без проверки — нет).

## 2. Terraform: Глубокое погружение

* **State файл:** Это JSON, в котором Terraform хранит карту соответствия твоих ресурсов в коде реальным ресурсам в облаке.
* *Backend:* Место, где лежит стейт (S3, GCS, Terraform Cloud). Важно использовать **Locking** (обычно через DynamoDB), чтобы два инженера не запустили `apply` одновременно и не испортили стейт.


* **Provisioners:** (local-exec, remote-exec) — это "костыли", позволяющие запустить скрипт после создания ресурса. Рекомендуется избегать в пользу Cloud-init или Ansible.
* **Data Sources:** Позволяют подтягивать информацию о ресурсах, созданных ВНЕ текущего кода Terraform (например, найти ID существующей сети VPC).

## 3. Ansible: Тонкости работы

* **Agentless:** В отличие от Chef или Puppet, на целевые сервера не нужно ставить софт. Достаточно SSH и Python.
* **Roles:** Способ структурировать код. Роль содержит в себе переменные, задачи, файлы и шаблоны (Jinja2). Это делает код переиспользуемым.
* **Variables Precedence:** В Ansible очень сложная иерархия переменных (их около 22 уровней). Важно помнить: переменные, переданные через `--extra-vars` в командной строке, всегда имеют высший приоритет.

---

## Команды и практика

| Инструмент | Команда | Что делает |
| --- | --- | --- |
| **Terraform** | `terraform fmt` | Форматирует код по стандарту |
| **Terraform** | `terraform taint <resource>` | Помечает ресурс как "битый", чтобы он был пересоздан при следующем apply |
| **Terraform** | `terraform import <resource>` | Добавляет уже существующий в облаке ресурс под управление Terraform |
| **Ansible** | `ansible-playbook site.yml -C` | Режим **Check mode** (пробный прогон без изменений) |
| **Ansible** | `ansible all -m ping` | Проверка связи со всеми серверами из инвентаря |
| **Ansible** | `ansible-vault encrypt vars.yml` | Шифрование файла с секретами |

---

### Темы для Senior уровня (Advanced)

1. **Refactoring в Terraform:** Использование блока `moved` для переименования ресурсов в стейте без их удаления.
2. **Ansible Strategy:** Разница между `linear` (ждем все сервера на каждом шаге) и `free` (каждый сервер идет по плейбуку максимально быстро).
3. **Provider Development:** Понимание того, что Terraform провайдер — это просто бинарник на Go, который общается с API облака.

**Этот блок закрывает вопросы по "железу" и конфигам. Готов переходить к Разделу V: CI/CD (GitLab, Jenkins, стратегии деплоя)?**