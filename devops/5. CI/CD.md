# Раздел V: CI/CD (Continuous Integration / Continuous Delivery)

## 1. Основные концепции

* **CI (Continuous Integration):** Практика частого слияния кода в общую ветку. Обязательно включает автоматическую сборку и тестирование. Цель — найти ошибки как можно раньше.
* **CD (Continuous Delivery):** Код всегда готов к деплою в продакшн, но само нажатие кнопки "Deploy" может быть ручным.
* **CD (Continuous Deployment):** Любое изменение, прошедшее тесты, автоматически улетает на продакшн без участия человека.

---

## 2. Анатомия Pipeline (Пайплайна)

Типичный пайплайн состоит из следующих стадий (Stages):

1. **Build:** Компиляция кода, сборка Docker-образа.
2. **Test:**
* *Unit-tests:* проверка логики функций.
* *Linting:* проверка стиля кода (ShellCheck для Bash, Hadolint для Docker).
* *SAST:* статический анализ кода на уязвимости (SonarQube, Snyk).


3. **Push:** Загрузка образа в Registry (GitLab Registry, Harbor, Nexus).
4. **Deploy to Staging:** Развертывание в тестовую среду.
5. **Integration/Smoke Tests:** Проверка, что приложение вообще запускается и отвечает.
6. **Deploy to Production:** Выкатка на реальных пользователей.

---

## 3. Стратегии развертывания (Deployment Strategies)

Это самый важный теоретический блок. Ты должен знать, как минимизировать Downtime.

* **Recreate:** Убиваем старые поды, запускаем новые. Есть простой (Downtime).
* **Rolling Update (стандарт K8s):** Постепенная замена подов (например, по одному). Если новый упал, старые еще работают.
* **Blue-Green:** Рядом с работающей версией (Blue) поднимается полная копия новой версии (Green). Когда Green протестирована, трафик на уровне балансировщика переключается на неё. Легкий откат (Rollback).
* **Canary:** Новая версия катится на 5% пользователей. Если метрики (ошибки, CPU) в норме — раскатываем на всех.
* **Shadow:** Новая версия получает копию реального трафика, но её ответы пользователю не уходят. Только для проверки нагрузки.

---

## 4. Инструментарий: GitLab CI vs Jenkins vs GitHub Actions

На собеседовании важно понимать разницу в подходах:

| Фича | Jenkins | GitLab CI / GitHub Actions |
| --- | --- | --- |
| **Подход** | Controller + Agents (Старый дедушка) | Cloud Native / Runner based |
| **Конфиг** | Groovy (Jenkinsfile) | YAML |
| **Плагины** | Огромная экосистема (часто ломаются) | Встроенные интеграции |
| **State** | Хранит всё на сервере (тяжело бекапить) | Stateless (всё в Git) |

---

## 5. GitOps: Новое слово в CD

Вместо того чтобы CI-система "толкала" (Push) код в кластер, используется **GitOps** (например, **ArgoCD** или **Flux**).

* **Принцип:** В Git лежит YAML-описание того, что должно быть в K8s. ArgoCD следит за Git и, если видит изменения, "подтягивает" (Pull) их в кластер.
* **Плюс:** Если кто-то руками поправит что-то в K8s (drift), ArgoCD вернет всё как было в Git. Git становится единственным источником правды.

---

## 6. Вопросы для проверки (Interview Questions)

* **В чем разница между `Pull` и `Push` моделью деплоя?** (Push — Jenkins лезет в кластер; Pull — агент внутри кластера тянет изменения из Git).
* **Что такое Shared Runners в GitLab?** (Общие ресурсы для сборки, чтобы не поднимать свои сервера).
* **Как сделать Rollback (откат), если бинарник уже развернут, но выдает 500-е ошибки?** (В K8s: `kubectl rollout undo`; в GitOps: просто revert коммита в Git).
* **Как передать секреты в пайплайн?** (Environment Variables, защищенные в настройках CI, или интеграция с HashiCorp Vault).

---

## 7. Команды и практика (GitLab CI / K8s)

* **Просмотр статуса деплоя:** `kubectl rollout status deployment/my-app`
* **История ревизий:** `kubectl rollout history deployment/my-app`
* **Ручной перезапуск (рестарт подов без смены версии):** `kubectl rollout restart deployment/my-app`
* **Отладка пайплайна:** Использование `artifacts` (сохранение логов/отчетов после шага) и `cache` (ускорение сборки за счет сохранения зависимостей, например `node_modules`).

---

**Этот блок объединяет всё воедино. Мы готовы двигаться к Разделу VI: Observability (Prometheus, Grafana, ELK)? Или хочешь углубиться в написание сложного пайплайна с Canary деплоем?**